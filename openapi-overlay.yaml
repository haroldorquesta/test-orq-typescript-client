overlay: 1.0.0
info:
  title: Overlay to fix deployment streaming response format
  version: 0.0.0
actions:
  - target: $["paths"]["/v2/deployments/invoke"]["post"]["responses"]["200"]["content"]["text/event-stream"]["schema"]["properties"]
    update:
      "data": {"type": "object", "properties": {"id": {"type": "string", "format": "ulid", "description": "A unique identifier for the response. Can be used to add metrics to the transaction.", "readOnly": true}, "created": {"type": "string", "format": "date-time", "description": "A timestamp indicating when the object was created. Usually in a standardized format like ISO 8601"}, "object": {"type": "string", "enum": ["chat", "completion", "image"], "description": "Indicates the type of model used to generate the response"}, "model": {"type": "string", "description": "The model used to generate the response"}, "provider": {"type": "string", "enum": ["cohere", "openai", "anthropic", "huggingface", "replicate", "google", "google-ai", "azure", "aws", "anyscale", "perplexity", "groq", "fal", "leonardoai", "nvidia"], "description": "The provider used to generate the response"}, "is_final": {"type": "boolean", "description": "Indicates if the response is the final response"}, "integration_id": {"type": "string", "description": "Indicates integration id used to generate the response"}, "finalized": {"type": "string", "format": "date-time", "description": "A timestamp indicating when the object was finalized. Usually in a standardized format like ISO 8601"}, "system_fingerprint": {"type": ["string", "null"], "description": "Provider backed system fingerprint."}, "choices": {"type": "array", "items": {"type": "object", "properties": {"index": {"type": "number"}, "message": {"anyOf": [{"type": "object", "properties": {"role": {"type": "string", "enum": ["system", "assistant", "user", "exception", "tool", "prompt", "correction", "expected_output"], "description": "The role of the prompt message"}, "content": {"type": ["string", "null"]}, "tool_calls": {"type": "array", "items": {"type": "object", "properties": {"id": {"type": "string"}, "index": {"type": "number"}, "type": {"type": "string", "enum": ["function"]}, "function": {"type": "object", "properties": {"name": {"type": "string"}, "arguments": {"type": "string", "description": "JSON string arguments for the functions"}}, "required": ["name", "arguments"]}}, "required": ["type", "function"]}}}, "required": ["role", "tool_calls"]}, {"type": "object", "properties": {"role": {"type": "string", "enum": ["system", "assistant", "user", "exception", "tool", "prompt", "correction", "expected_output"], "description": "The role of the prompt message"}, "content": {"type": ["string", "null"]}}, "required": ["role", "content"]}, {"type": "object", "properties": {"role": {"type": "string", "enum": ["system", "assistant", "user", "exception", "tool", "prompt", "correction", "expected_output"], "description": "The role of the prompt message"}, "url": {"type": "string"}}, "required": ["role", "url"]}]}, "finish_reason": {"type": ["string", "null"]}}, "required": ["index"]}, "description": "A list of choices generated by the model"}, "retrievals": {"type": "array", "items": {"type": "object", "properties": {"document": {"type": "string", "description": "Content of the retrieved chunk from the knowledge base"}, "metadata": {"type": "object", "properties": {"file_name": {"type": "string", "description": "Name of the file"}, "page_number": {"type": ["number", "null"], "description": "Page number of the chunk"}, "file_type": {"type": "string", "description": "Type of the file"}, "rerank_score": {"type": "number", "description": "Rerank scores are normalized to be in the range [0, 1]. Scores close to 1 indicate a high relevance to the query, and scores closer to 0 indicate low relevance. It is not accurate to assume a score of 0.9 means the document is 2x more relevant than a document with a score of 0.45"}, "search_score": {"type": "number", "description": "Search scores are normalized to be in the range [0, 1]. Search score is calculated based on `[Cosine Similarity](https://en.wikipedia.org/wiki/Cosine_similarity)` algorithm. Scores close to 1 indicate the document is closer to the query, and scores closer to 0 indicate the document is farther from the query."}}, "required": ["file_name", "page_number", "file_type", "search_score"], "description": "Metadata of the retrieved chunk from the knowledge base"}}, "required": ["document", "metadata"]}, "description": "List of documents retrieved from the knowledge base. This property is only available when the `include_retrievals` flag is set to `true` in the invoke settings. When stream is set to true, the `retrievals` property will be returned in the last streamed chunk where the property `is_final` is set to `true`."}, "provider_response": {"description": "Response returned by the model provider. This functionality is only supported when streaming is not used. If streaming is used, the `provider_response` property will be set to `null`."}}}
  - target: $["paths"]["/v2/deployments/invoke"]["post"]["responses"]["200"]["content"]["text/event-stream"]["schema"]["properties"]["id"]
    remove: true
  - target: $["paths"]["/v2/deployments/invoke"]["post"]["responses"]["200"]["content"]["text/event-stream"]["schema"]["properties"]["created"]
    remove: true
  - target: $["paths"]["/v2/deployments/invoke"]["post"]["responses"]["200"]["content"]["text/event-stream"]["schema"]["properties"]["object"]
    remove: true
  - target: $["paths"]["/v2/deployments/invoke"]["post"]["responses"]["200"]["content"]["text/event-stream"]["schema"]["properties"]["model"]
    remove: true
  - target: $["paths"]["/v2/deployments/invoke"]["post"]["responses"]["200"]["content"]["text/event-stream"]["schema"]["properties"]["provider"]
    remove: true
  - target: $["paths"]["/v2/deployments/invoke"]["post"]["responses"]["200"]["content"]["text/event-stream"]["schema"]["properties"]["is_final"]
    remove: true
  - target: $["paths"]["/v2/deployments/invoke"]["post"]["responses"]["200"]["content"]["text/event-stream"]["schema"]["properties"]["integration_id"]
    remove: true
  - target: $["paths"]["/v2/deployments/invoke"]["post"]["responses"]["200"]["content"]["text/event-stream"]["schema"]["properties"]["finalized"]
    remove: true
  - target: $["paths"]["/v2/deployments/invoke"]["post"]["responses"]["200"]["content"]["text/event-stream"]["schema"]["properties"]["system_fingerprint"]
    remove: true
  - target: $["paths"]["/v2/deployments/invoke"]["post"]["responses"]["200"]["content"]["text/event-stream"]["schema"]["properties"]["choices"]
    remove: true
  - target: $["paths"]["/v2/deployments/invoke"]["post"]["responses"]["200"]["content"]["text/event-stream"]["schema"]["properties"]["retrievals"]
    remove: true
  - target: $["paths"]["/v2/deployments/invoke"]["post"]["responses"]["200"]["content"]["text/event-stream"]["schema"]["properties"]["provider_response"]
    remove: true
